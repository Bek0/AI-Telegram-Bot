# Complete Dashboard & Bot Integration Analysis

## 1. Updated Project Structure

```
/project_root
├── main.py (FastAPI app for dashboard)
├── main_telegram.py (Telegram bot entry point)
├── db_connection.py (Database connections)
├── connection.py (SQL Server connection)
│
├── /dashboard
│   ├── __init__.py
│   ├── auth.py (Session management)
│   ├── routes.py (API endpoints)
│   ├── utils.py (Helper functions)
│   │
│   ├── /templates
│   │   ├── login.html (Authentication UI)
│   │   ├── dashboard.html (Main dashboard)
│   │   └── costs.html (Billing dashboard)
│   │
│   └── /static
│       ├── /css
│       │   └── style.css (Styling)
│       └── /js
│           ├── login.js (Login logic)
│           └── dashboard.js (Dashboard interactions)
│
├── /services
│   ├── telegram_service.py (Bot command handlers)
│   ├── telegram_llm_service.py (LLM orchestration)
│   ├── telegram_auth.py (User management)
│   ├── organization_manager.py (Org operations)
│   ├── database_manager.py (DB connections)
│   ├── send_email.py (Email service)
│   ├── sql_service.py (SQL execution)
│   ├── token_cost_calculator.py (Cost tracking)
│   └── telegram_logging.py (Activity logging)
│
├── /memory
│   └── telegram_conversation.py (Conversation memory)
│
├── /models
│   └── pydantic_models.py (Data validation)
│
├── /utils
│   └── prompts.py (LLM templates)
│
└── /logs
    ├── telegram_activity.log
    ├── bot.log
    └── /conversations (Chat histories)
```

---

## 2. Dashboard-Bot Interaction Architecture

### Authentication Flow

```
┌─ Telegram User ─────────────────┐
│  /createorg, /adddb, /join      │
└────────────────┬────────────────┘
                 │
         ┌───────▼────────┐
         │ Bot generates  │
         │ Dashboard creds│
         │ (username/pwd) │
         └───────┬────────┘
                 │
        ┌────────▼─────────┐
        │ Store in SQL:    │
        │ dashboard_users  │
        │ (org_id, user_id,│
        │  username, hash) │
        └────────┬─────────┘
                 │
    ┌────────────▼─────────────┐
    │ Web Browser Dashboard    │
    │ Login with credentials   │
    └────────────┬─────────────┘
                 │
        ┌────────▼────────────┐
        │ /dashboard/login    │
        │ Verify credentials  │
        │ Create session      │
        │ Return JWT token    │
        └────────┬─────────────┘
                 │
    ┌────────────▼─────────────┐
    │ Bearer Token in Headers  │
    │ All subsequent requests  │
    └─────────────────────────┘
```

### Data Integration Points

**Bot → Dashboard:**
- User creates organization in Telegram
- Dashboard credentials auto-generated
- Stored in SQL Server `dashboard_users` table
- User can now access web dashboard

**Dashboard ↔ Bot:**
- Both read/write to same SQL databases
- Organization data synced
- Member operations reflected immediately
- Database connections managed from dashboard

**Cost Tracking:**
- Bot calculates token usage for each conversation
- Stores in `ConversationStages` and `Conversations` tables
- Dashboard reads these tables to display analytics
- Costs aggregated by model, stage, and user

---

## 3. Role-Based Access Control

### User Roles

| Role | Location | Permissions |
|------|----------|-------------|
| **Admin** | Environment Variable | System administration (not UI-visible) |
| **Org Owner** | Created via `/createorg` | Create/remove members, add databases, create invitations, view costs |
| **Org Member** | Joined via `/join` | Use databases, view conversations, cannot manage org |
| **Individual User** | No organization | Create personal databases only |

### Dashboard Access Matrix

```
                    Owner    Member   Individual
┌──────────────────┼────────┼────────┼────────────┐
│ View Members     │   ✓    │   ✓    │     ✗      │
│ Add Members      │   ✓    │   ✗    │     ✗      │
│ Remove Members   │   ✓    │   ✗    │     ✗      │
│ View Databases   │   ✓    │   ✓    │     ✓      │
│ Add Databases    │   ✓    │   ✗    │     ✓      │
│ Remove Databases │   ✓    │   ✗    │     ✗      │
│ Create Invites   │   ✓    │   ✗    │     ✗      │
│ View Costs       │   ✓    │   ✗    │     ✗      │
│ View Overview    │   ✓    │   ✓    │     ✓      │
└──────────────────┴────────┴────────┴────────────┘
```

## 4. Key API Endpoints Reference

### Authentication Endpoints
```
POST /dashboard/login
  → Authenticate user with dashboard credentials
  ← Returns: token, role, org_id, org_name

POST /dashboard/logout
  → Invalidate session
  
GET /dashboard/verify
  → Check if token is valid
```

### Organization Management Endpoints (Owner Only)
```
GET /dashboard/overview
  → Org stats, member count, database count
  
GET /dashboard/members
  → List all organization members with roles
  
POST /dashboard/members/add
  → Add member by user_id

POST /dashboard/members/remove
  → Remove member from organization

GET /dashboard/invitations
  → List all active/expired invitations

POST /dashboard/invitations/create
  → Generate new invitation code
```

### Database Management Endpoints (Owner Only)
```
GET /dashboard/databases
  → List org databases
  
POST /dashboard/databases/create
  → Add new database connection
  
POST /dashboard/databases/remove
  → Remove database from organization
```

### Cost Analytics Endpoints (Owner Only)
```
GET /dashboard/costs/overview
  → Total costs, tokens, conversations
  
GET /dashboard/costs/by-model
  → Breakdown by Gemini model
  
GET /dashboard/costs/by-stage
  → Breakdown by processing stage
  
GET /dashboard/costs/input-output
  → Input vs output cost split
  
GET /dashboard/costs/per-user
  → Cost breakdown per team member
```

---

## 5. Database Schema Relationships

### Manager Database Schema
```sql
-- Organizations
CREATE TABLE organizations (
  org_id VARCHAR(50) PRIMARY KEY,
  name NVARCHAR(255),
  owner_id BIGINT,
  created_at DATETIME,
  description NVARCHAR(MAX)
);

-- Organization Members
CREATE TABLE organization_members (
  org_id VARCHAR(50),
  user_id BIGINT,
  joined_at DATETIME,
  role VARCHAR(20), -- 'owner' or 'member'
  PRIMARY KEY (org_id, user_id)
);

-- Dashboard Users (For Web Access)
CREATE TABLE dashboard_users (
  org_id VARCHAR(50),
  user_id BIGINT,
  username VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255),
  role VARCHAR(20), -- 'owner' or 'member'
  is_active BIT DEFAULT 1,
  created_at DATETIME DEFAULT GETDATE()
);

-- Database Connections
CREATE TABLE database_connections (
  connection_id VARCHAR(50) PRIMARY KEY,
  name NVARCHAR(255),
  connection_string NVARCHAR(MAX),
  owner_type VARCHAR(20), -- 'organization' or 'user'
  owner_id VARCHAR(50),
  created_by BIGINT,
  created_at DATETIME,
  is_active BIT DEFAULT 1,
  last_used DATETIME
);

-- Organization Databases Link
CREATE TABLE organization_databases (
  org_id VARCHAR(50),
  connection_id VARCHAR(50),
  added_at DATETIME DEFAULT GETDATE(),
  PRIMARY KEY (org_id, connection_id)
);

-- Invitations
CREATE TABLE invitations (
  invite_code VARCHAR(50) PRIMARY KEY,
  org_id VARCHAR(50),
  created_by BIGINT,
  created_at DATETIME,
  expires_at DATETIME,
  max_uses INT,
  current_uses INT DEFAULT 0,
  is_active BIT DEFAULT 1
);
```

### Costs Database Schema
```sql
-- Conversations Log
CREATE TABLE Conversations (
  conversation_id INT PRIMARY KEY IDENTITY,
  chat_id BIGINT,
  user_id BIGINT,
  username NVARCHAR(255),
  user_question NVARCHAR(MAX),
  org_id VARCHAR(50),
  database_id VARCHAR(50),
  timestamp DATETIME DEFAULT GETDATE()
);

-- Cost Per Stage
CREATE TABLE ConversationStages (
  stage_id INT PRIMARY KEY IDENTITY,
  conversation_id INT,
  chat_id BIGINT,
  stage_number INT,
  stage_name NVARCHAR(100), -- 'Analysis', 'SQL Response', 'Email Generation'
  model_name NVARCHAR(50), -- 'gemini-2.5-flash', 'gemini-2.0-flash'
  input_tokens INT,
  output_tokens INT,
  total_tokens INT,
  input_cost DECIMAL(18,8),
  output_cost DECIMAL(18,8),
  total_cost DECIMAL(18,8)
);

-- Model Usage Aggregation
CREATE TABLE ModelUsage (
  chat_id BIGINT,
  model_name NVARCHAR(50),
  times_used INT,
  input_tokens BIGINT,
  output_tokens BIGINT,
  total_tokens BIGINT,
  input_cost DECIMAL(18,8),
  output_cost DECIMAL(18,8),
  total_cost DECIMAL(18,8),
  input_price_per_1m DECIMAL(18,8)
);
```

# Database Schema & Cost Tracking Architecture (Continued)

```sql
10);

-- Stage Usage Aggregation
CREATE TABLE StagesUsage (
  chat_id BIGINT,
  stage_name NVARCHAR(100),
  times_used INT,
  input_tokens BIGINT,
  output_tokens BIGINT,
  total_tokens BIGINT,
  input_cost DECIMAL(18,8),
  output_cost DECIMAL(18,8),
  total_cost DECIMAL(18,8),
  last_updated DATETIME DEFAULT GETDATE()
);

-- Organization-Level Aggregations
CREATE TABLE OrgModelUsage (
  org_id VARCHAR(50),
  model_name NVARCHAR(50),
  times_used INT,
  input_tokens BIGINT,
  output_tokens BIGINT,
  total_tokens BIGINT,
  input_cost DECIMAL(18,8),
  output_cost DECIMAL(18,8),
  total_cost DECIMAL(18,8),
  last_updated DATETIME DEFAULT GETDATE()
);

CREATE TABLE OrgStagesUsage (
  org_id VARCHAR(50),
  stage_name NVARCHAR(100),
  times_used INT,
  input_tokens BIGINT,
  output_tokens BIGINT,
  total_tokens BIGINT,
  input_cost DECIMAL(18,8),
  output_cost DECIMAL(18,8),
  total_cost DECIMAL(18,8),
  last_updated DATETIME DEFAULT GETDATE()
);

-- Conversation Summary
CREATE TABLE ConversationSummary (
  conversation_id INT PRIMARY KEY,
  chat_id BIGINT,
  total_stages INT,
  input_tokens BIGINT,
  output_tokens BIGINT,
  total_tokens BIGINT,
  input_cost DECIMAL(18,8),
  output_cost DECIMAL(18,8),
  total_cost DECIMAL(18,8),
  most_expensive_stage_name NVARCHAR(100),
  most_expensive_stage_tokens INT,
  most_expensive_stage_percentage DECIMAL(5,2),
  timestamp DATETIME DEFAULT GETDATE()
);
```

---

## 6. System Integration Summary Table

| Component | Purpose | Interaction | Data Flow |
|-----------|---------|-------------|-----------|
| **Telegram Bot** | User interaction, question processing | Receives commands, processes NLP | → Stores in SQL, Costs DB |
| **Organization Manager** | Manage teams & permissions | Handles orgs, members, invitations | ↔ Manager DB |
| **Database Manager** | Abstract DB connections | Pool connections, verify access | ↔ Manager DB |
| **LLM Service** | Question processing & cost tracking | 3-stage pipeline with token counting | → Costs DB (stages, tokens) |
| **Token Calculator** | Track usage & billing | Per-stage cost calculation | → Costs DB tables |
| **Dashboard (FastAPI)** | Web UI for management | REST API endpoints | ← Reads Manager & Costs DB |
| **Session Manager** | Authentication & authorization | JWT token lifecycle | In-memory _sessions dict |
| **Dashboard UI (JS)** | User interface | Calls API endpoints, displays data | ↔ Dashboard API |

---

## 7. Key Features & Access Patterns

### Owner-Only Features
```
├── Cost Analytics
│   ├── Total spending dashboard
│   ├── Per-model breakdown (Gemini 2.5-Flash vs 2.0-Flash)
│   ├── Per-stage analysis (Analysis vs SQL vs Email)
│   └── Per-user billing attribution
│
├── Member Management
│   ├── Add members (new or existing users)
│   ├── Remove members (automatic DB disconnect)
│   └── View all member activity
│
├── Database Administration
│   ├── Add new database connections
│   ├── Remove databases
│   └── Manage access permissions
│
└── Invitation Management
    ├── Generate time-limited codes
    ├── Set usage limits
    └── Track invitation usage
```

### Member Features (Read-Only)
```
├── View Organization Overview
│   ├── Total members
│   ├── Available databases
│   └── Join date
│
├── Browse Databases
│   ├── List all org databases
│   └── Select active database (for bot use)
│
└── View Team Members
    └── See names and join dates
```

---

## 8. Error Handling & Security

### Authentication Security---

## 9. Production Deployment Checklist

### Security Hardening

```yaml
Authentication:
  ✓ Password hashing with PBKDF2 (100,000 iterations)
  ✓ Random token generation (32 bytes)
  ✓ Session timeout (24 hours)
  ✓ Rate limiting (5 attempts/5 min)
  ✓ HTTPS enforcement
  ✓ CORS properly configured

Database Access:
  ✓ Parameterized SQL queries (prevent injection)
  ✓ Role-based access control (RBAC)
  ✓ Connection pooling with timeouts
  ✓ Separate databases for org data vs costs
  ✓ SQL Server authentication via connection string

API Security:
  ✓ Bearer token in Authorization header
  ✓ Token validation on every request
  ✓ Session expiry checks
  ✓ Encrypted connections (TLS 1.2+)
  ✓ CSRF protection for POST requests

Data Protection:
  ✓ Never log passwords or tokens
  ✓ Clear sensitive data on logout
  ✓ Audit trail for member/database changes
  ✓ Cost data restricted to org owners only
  ✓ Member data only visible within org

Infrastructure:
  ✓ Environment variables for secrets
  ✓ No hardcoded credentials
  ✓ Firewall rules for database access
  ✓ SSL certificates for dashboard
  ✓ Regular security audits
```

### Performance Optimization

```yaml
Caching:
  ✓ Conversation memory (5-min TTL)
  ✓ Session cache (in-memory)
  ✓ Database connection pooling
  ✓ LLM response caching where applicable

Async Operations:
  ✓ Background file writing queue
  ✓ Non-blocking email sending
  ✓ Concurrent request handling
  ✓ ThreadPoolExecutor for CPU-bound tasks

Database Queries:
  ✓ Indexed columns (org_id, user_id, created_at)
  ✓ Materialized views for cost aggregation
  ✓ Partitioning conversations by date
  ✓ Query optimization for reports

Monitoring:
  ✓ APM instrumentation (NewRelic, DataDog)
  ✓ Error tracking (Sentry)
  ✓ Cost analytics dashboarding
  ✓ Performance metrics collection
```

---

## 10. Conclusion: Complete System Architecture

The integrated bot-dashboard system provides:

| Aspect | Coverage |
|--------|----------|
| **Multi-tenant Support** | Organizations isolate members while sharing infrastructure |
| **Role-based Access** | Owner/Member distinction with appropriate UI/API restrictions |
| **Cost Transparency** | Granular token/cost tracking per user, model, and stage |
| **Real-time Sync** | Both bot and dashboard operate on same SQL databases |
| **Web Management** | Dashboard for non-technical users to manage teams & billing |
| **Audit Trail** | Complete logging of user actions and API calls |
| **Security** | Industry-standard authentication, authorization, and encryption |
| **Scalability** | Async-first, connection pooling, caching for performance |

The system enables organizations to:
- Deploy AI conversational agents for data analysis
- Track usage and costs at individual and team levels
- Manage member access to databases
- Monitor LLM performance and optimize spending
- Maintain security and compliance requirements