graph TD
    Start["๐ ูุชุญ ุงูุฏุงุดุจูุฑุฏ"] --> Login["๐ ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู"]
    Login --> EnterCreds["ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ"]
    EnterCreds --> SubmitLogin["ุฅุฑุณุงู POST /dashboard/login"]
    SubmitLogin --> QueryDB["๐ ุงูุจุญุซ ูู dashboard_users"]
    QueryDB --> VerifyHash["ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ"]
    VerifyHash --> Valid{ุตุญูุญุฉุ}
    
    Valid -->|ูุง| LoginError["โ ุฎุทุฃ ูู ุจูุงูุงุช ุงูุฏุฎูู"]
    LoginError --> EnterCreds
    
    Valid -->|ูุนู| CreateSession["๐ ุฅูุดุงุก ุฌูุณุฉ JWT"]
    CreateSession --> StoreSession["ุญูุธ ูู _sessions<br/>ูุฏุฉ 24 ุณุงุนุฉ"]
    StoreSession --> SaveLocal["๐พ ุญูุธ ูู localStorage"]
    SaveLocal --> RedirectDash["โช๏ธ ุงูุงูุชูุงู ุฅูู /dashboard/"]
    
    %% ===== ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ =====
    RedirectDash --> LoadDash["๐ ุชุญููู ููุญุฉ ุงููุนูููุงุช"]
    LoadDash --> GetOverview["GET /dashboard/overview"]
    GetOverview --> QueryOrg["๐ ุงุณุชุนูุงู organizations"]
    QueryOrg --> QueryMembers["๐ ุนุฏุฏ ุงูุฃุนุถุงุก"]
    QueryMembers --> QueryDBs["๐ ุนุฏุฏ ุงูููุงุนุฏ"]
    QueryDBs --> QueryInvites["๐ ุงูุฏุนูุงุช ุงููุดุทุฉ"]
    QueryInvites --> DisplayCards["๐ ุนุฑุถ ุงูุจุทุงูุงุช:<br/>๐ฅ ุนุฏุฏ ุงูุฃุนุถุงุก<br/>๐๏ธ ุนุฏุฏ ุงูููุงุนุฏ<br/>๐ซ ุงูุฏุนูุงุช<br/>๐ ุชุงุฑูุฎ ุงูุฅูุดุงุก"]
    
    DisplayCards --> CheckRole{ุฏูุฑ ุงููุณุชุฎุฏูุ}
    
    %% ===== ุนุถู ุนุงุฏู =====
    CheckRole -->|ุนุถู ุนุงุฏู| MemberView["๐๏ธ ุนุฑุถ ูุญุฏูุฏ"]
    MemberView --> HideTabs["โ ุฅุฎูุงุก ุงูุชุจููุจุงุช:<br/>- ุงูุฏุนูุงุช<br/>- ุงูุชูุงููู"]
    HideTabs --> ShowMemberTabs["โ ุนุฑุถ ููุท:<br/>- ุงูุฃุนุถุงุก (ูุฑุงุกุฉ)<br/>- ุงูููุงุนุฏ (ูุฑุงุกุฉ + ุงุฎุชูุงุฑ)"]
    ShowMemberTabs --> MemberTabSelect{ุงูุชุจููุจุ}
    
    MemberTabSelect -->|ุงูุฃุนุถุงุก| ViewMembers["๐ฅ ุนุฑุถ ุงูุฃุนุถุงุก<br/>(ูุฑุงุกุฉ ููุท)"]
    ViewMembers --> ShowMembersList["ุนุฑุถ:<br/>ุงูุงุณูุ ุงูุฏูุฑุ ุงูุชุงุฑูุฎ"]
    ShowMembersList --> MemberTabSelect
    
    MemberTabSelect -->|ุงูููุงุนุฏ| ViewDBs["๐๏ธ ุนุฑุถ ุงูููุงุนุฏ"]
    ViewDBs --> ShowDBsList["ุนุฑุถ ูุงุฆูุฉ ุงูููุงุนุฏ"]
    ShowDBsList --> SelectOption["โ ุฅููุงููุฉ ุงูุงุฎุชูุงุฑ"]
    SelectOption --> MemberTabSelect
    
    %% ===== ูุงูู ุงููุคุณุณุฉ =====
    CheckRole -->|ูุงูู ุงููุคุณุณุฉ| OwnerView["โ๏ธ ุนุฑุถ ูุงูู"]
    OwnerView --> ShowAllTabs["โ ุฌููุน ุงูุชุจููุจุงุช:<br/>- ุงูุฃุนุถุงุก<br/>- ุงูููุงุนุฏ<br/>- ุงูุฏุนูุงุช<br/>- ุงูุชูุงููู"]
    ShowAllTabs --> OwnerTabSelect{ุงูุชุจููุจ ุงููุฎุชุงุฑุ}
    
    %% ===== ุชุจููุจ ุงูุฃุนุถุงุก =====
    OwnerTabSelect -->|ุงูุฃุนุถุงุก| MembersTab["๐ฅ ุชุจููุจ ุงูุฃุนุถุงุก"]
    MembersTab --> GetMembers["GET /dashboard/members"]
    GetMembers --> QueryMembersList["๐ ุงุณุชุนูุงู organization_members"]
    QueryMembersList --> DisplayMembersTable["๐ ุนุฑุถ ุฌุฏูู ุงูุฃุนุถุงุก"]
    DisplayMembersTable --> MemberAction{ุงูุฅุฌุฑุงุกุ}
    
    MemberAction -->|ุฅุถุงูุฉ ุนุถู| AddMemberForm["โ ูููุฐุฌ ุฅุถุงูุฉ ุนุถู"]
    AddMemberForm --> EnterUserID["ุฅุฏุฎุงู ูุนุฑู ุงููุณุชุฎุฏู"]
    EnterUserID --> GenMemberCreds["๐ ุชูููุฏ ุจูุงูุงุช ุงูุฏุฎูู"]
    GenMemberCreds --> PostAddMember["POST /dashboard/members/add"]
    PostAddMember --> SaveMember["๐พ ุญูุธ ูู:<br/>- dashboard_users<br/>- organization_members"]
    SaveMember --> RefreshMembers["๐ ุชุญุฏูุซ ุงูุฌุฏูู"]
    RefreshMembers --> MembersTab
    
    MemberAction -->|ุญุฐู ุนุถู| ConfirmRemove["โ๏ธ ุชุฃููุฏ ุงูุญุฐู"]
    ConfirmRemove --> PostRemoveMember["POST /dashboard/members/remove"]
    PostRemoveMember --> DisconnectDBs["ูุตู ุนู ุงูููุงุนุฏ"]
    DisconnectDBs --> DeleteMember["๐๏ธ ุญุฐู ูู:<br/>- organization_members<br/>- dashboard_users"]
    DeleteMember --> RefreshMembers
    
    MemberAction -->|ุนุฑุถ ููุท| MembersTab
    
    %% ===== ุชุจููุจ ุงูููุงุนุฏ =====
    OwnerTabSelect -->|ุงูููุงุนุฏ| DatabasesTab["๐๏ธ ุชุจููุจ ุงูููุงุนุฏ"]
    DatabasesTab --> GetDBs["GET /dashboard/databases"]
    GetDBs --> QueryDBsList["๐ ุงุณุชุนูุงู:<br/>- organization_databases<br/>- database_connections"]
    QueryDBsList --> DisplayDBsTable["๐ ุนุฑุถ ุฌุฏูู ุงูููุงุนุฏ"]
    DisplayDBsTable --> DBAction{ุงูุฅุฌุฑุงุกุ}
    
    DBAction -->|ุฅุถุงูุฉ ูุงุนุฏุฉ| AddDBForm["โ ูููุฐุฌ ุฅุถุงูุฉ ูุงุนุฏุฉ"]
    AddDBForm --> EnterDBInfo["ุฅุฏุฎุงู:<br/>- ุงูุงุณู<br/>- Connection String<br/>- ุงูููุน"]
    EnterDBInfo --> TestConnection["โ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู"]
    TestConnection --> ConnValid{ุตุญูุญุ}
    ConnValid -->|ูุง| ConnErr["โ ุฎุทุฃ ูู ุงูุงุชุตุงู"]
    ConnErr --> AddDBForm
    ConnValid -->|ูุนู| PostAddDB["POST /dashboard/databases/create"]
    PostAddDB --> SaveDBConn["๐พ ุญูุธ ูู:<br/>- database_connections<br/>- organization_databases"]
    SaveDBConn --> NotifyAllMembers["๐ข ุฅุดุนุงุฑ ุฌููุน ุงูุฃุนุถุงุก"]
    NotifyAllMembers --> RefreshDBs["๐ ุชุญุฏูุซ ุงูุฌุฏูู"]
    RefreshDBs --> DatabasesTab
    
    DBAction -->|ุญุฐู ูุงุนุฏุฉ| ConfirmDeleteDB["โ๏ธ ุชุฃููุฏ ุงูุญุฐู"]
    ConfirmDeleteDB --> PostRemoveDB["POST /dashboard/databases/remove"]
    PostRemoveDB --> ClearMemberCache["ูุณุญ ูู ุฐุงูุฑุฉ ุงูุฃุนุถุงุก"]
    ClearMemberCache --> DeleteDBConn["๐๏ธ ุญุฐู ูู:<br/>- organization_databases<br/>- database_connections"]
    DeleteDBConn --> RefreshDBs
    
    DBAction -->|ุนุฑุถ ููุท| DatabasesTab
    
    %% ===== ุชุจููุจ ุงูุฏุนูุงุช =====
    OwnerTabSelect -->|ุงูุฏุนูุงุช| InvitationsTab["๐ซ ุชุจููุจ ุงูุฏุนูุงุช"]
    InvitationsTab --> GetInvites["GET /dashboard/invitations"]
    GetInvites --> QueryInvites2["๐ ุงุณุชุนูุงู invitations"]
    QueryInvites2 --> DisplayInvitesTable["๐ ุนุฑุถ ุงูุฏุนูุงุช:<br/>- ุงููุดุทุฉ<br/>- ุงูููุชููุฉ"]
    DisplayInvitesTable --> InviteAction{ุงูุฅุฌุฑุงุกุ}
    
    InviteAction -->|ุฅูุดุงุก ุฏุนูุฉ| CreateInviteForm["โ ูููุฐุฌ ุฏุนูุฉ ุฌุฏูุฏุฉ"]
    CreateInviteForm --> SetInviteParams["ุชุญุฏูุฏ:<br/>- ุนุฏุฏ ุงูุงุณุชุฎุฏุงูุงุช<br/>- ูุฏุฉ ุงูุตูุงุญูุฉ"]
    SetInviteParams --> GenInviteCode["ุชูููุฏ ุฑูุฒ ูุฑูุฏ"]
    GenInviteCode --> PostCreateInvite["POST /dashboard/invitations/create"]
    PostCreateInvite --> SaveInvite2["๐พ ุญูุธ ูู invitations"]
    SaveInvite2 --> DisplayInviteLink["๐ ุนุฑุถ ุฑุงุจุท ุงูุฏุนูุฉ"]
    DisplayInviteLink --> CopyLink["๐ ูุณุฎ ุงูุฑุงุจุท"]
    CopyLink --> InvitationsTab
    
    InviteAction -->|ุนุฑุถ ููุท| InvitationsTab
    
    %% ===== ุชุจููุจ ุงูุชูุงููู =====
    OwnerTabSelect -->|ุงูุชูุงููู| CostsTab["๐ฐ ุชุจููุจ ุงูุชูุงููู"]
    CostsTab --> GetCosts["GET /dashboard/costs"]
    GetCosts --> QueryCostsDB["๐ ุงุณุชุนูุงู ูุงุนุฏุฉ ุงูุชูุงููู"]
    QueryCostsDB --> LoadCostData["ุชุญููู ุงูุจูุงูุงุช ูู:<br/>- ModelUsage<br/>- StagesUsage<br/>- OrgModelUsage"]
    
    LoadCostData --> CostsSummary["๐ ุงููุธุฑุฉ ุงูุนุงูุฉ"]
    CostsSummary --> DisplaySummaryCards["ุนุฑุถ ุงูุจุทุงูุงุช:<br/>๐ฐ ุฅุฌูุงูู ุงูุชูุงููู<br/>๐ฅ ุฅุฌูุงูู ุงููุฏุฎูุงุช<br/>๐ค ุฅุฌูุงูู ุงููุฎุฑุฌุงุช<br/>๐ฌ ุนุฏุฏ ุงููุญุงุฏุซุงุช"]
    
    DisplaySummaryCards --> CostsByModel["๐ค ุงูุชูุงููู ุญุณุจ ุงููููุฐุฌ"]
    CostsByModel --> GetModelCosts["GET /dashboard/costs/by-model"]
    GetModelCosts --> QueryModelUsage["๐ ุงุณุชุนูุงู ModelUsage"]
    QueryModelUsage --> DisplayModelTable["๐ ุฌุฏูู ุงูููุงุฐุฌ:<br/>- ุงุณู ุงููููุฐุฌ<br/>- ุนุฏุฏ ุงูุงุณุชุฎุฏุงูุงุช<br/>- ุงูุชูููุงุช<br/>- ุงูุชูุงููู"]
    
    DisplayModelTable --> CostsByStage["๐ ุงูุชูุงููู ุญุณุจ ุงููุฑุญูุฉ"]
    CostsByStage --> GetStageCosts["GET /dashboard/costs/by-stage"]
    GetStageCosts --> QueryStageUsage["๐ ุงุณุชุนูุงู StagesUsage"]
    QueryStageUsage --> DisplayStageTable["๐ ุฌุฏูู ุงููุฑุงุญู:<br/>- Analysis<br/>- SQL Execution<br/>- Email Generation"]
    
    DisplayStageTable --> CostsDistribution["๐ ุชูุฒูุน ุงูุชูุงููู"]
    CostsDistribution --> CalcIODistribution["ุญุณุงุจ:<br/>- ูุณุจุฉ ุงููุฏุฎูุงุช<br/>- ูุณุจุฉ ุงููุฎุฑุฌุงุช"]
    CalcIODistribution --> DisplayPieChart["๐ฅง ุฑุณู ุจูุงูู ุฏุงุฆุฑู"]
    DisplayPieChart --> DisplayDistTable["๐ ุฌุฏูู ุงูุชูุถูุญ"]
    
    DisplayDistTable --> CostsByUser["๐ฅ ุงูุชูุงููู ููู ูุณุชุฎุฏู"]
    CostsByUser --> GetUserCosts["GET /dashboard/costs/by-user"]
    GetUserCosts --> QueryUserConvs["๐ ุงุณุชุนูุงู:<br/>- Conversations<br/>- ModelUsage"]
    QueryUserConvs --> CalcUserStats["ุญุณุงุจ:<br/>- ูุชูุณุท ุงูุชูููุฉ/ุนุถู<br/>- ุฅุฌูุงูู ุงููุคุณุณุฉ"]
    CalcUserStats --> DisplayUserCards["๐ ุจุทุงูุงุช ุงูููุฎุต"]
    DisplayUserCards --> DisplayUserTable["๐ ุฌุฏูู ุงููุณุชุฎุฏููู:<br/>- ูุนุฑู ุงููุณุชุฎุฏู<br/>- ุงุณู ุงููุณุชุฎุฏู<br/>- ุนุฏุฏ ุงููุญุงุฏุซุงุช<br/>- ุงูุชูููุงุช<br/>- ุงูุชูุงููู"]
    
    DisplayUserTable --> CostActions["โ๏ธ ุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ"]
    CostActions --> CostActionSelect{ุงูุฅุฌุฑุงุกุ}
    CostActionSelect -->|ุชุญุฏูุซ| RefreshCosts["๐ ุชุญุฏูุซ ุงูุจูุงูุงุช"]
    CostActionSelect -->|ุชุตุฏูุฑ| ExportReport["๐ฅ ุชุตุฏูุฑ ุชูุฑูุฑ"]
    CostActionSelect -->|ุชูุฒูู| DownloadData["๐พ ุชุญููู CSV"]
    CostActionSelect -->|ูุณุญ| ClearFilters["๐งน ูุณุญ ุงูููุงุชุฑ"]
    RefreshCosts --> CostsTab
    ExportReport --> CostsTab
    DownloadData --> CostsTab
    ClearFilters --> CostsTab
    CostActionSelect -->|ุฑุฌูุน| OwnerTabSelect
    
    %% ===== ุงูุฑุฌูุน ูุงูุฎุฑูุฌ =====
    MemberTabSelect -->|ุฑุฌูุน| CheckRole
    OwnerTabSelect -->|ุฑุฌูุน| CheckRole
    
    CheckRole --> LogoutAction{ุชุณุฌูู ุงูุฎุฑูุฌุ}
    LogoutAction -->|ูุนู| ClickLogout["๐ด ุงูุถุบุท ุนูู ุงูุฎุฑูุฌ"]
    ClickLogout --> PostLogout["POST /dashboard/logout"]
    PostLogout --> DeleteSession["๐๏ธ ุญุฐู ุงูุฌูุณุฉ"]
    DeleteSession --> ClearStorage["ูุณุญ localStorage"]
    ClearStorage --> RedirectLogin["โช๏ธ ุงูุนูุฏุฉ ูุตูุญุฉ ุงูุฏุฎูู"]
    RedirectLogin --> Login
    
    LogoutAction -->|ูุง| CheckRole
    
    style Start fill:#0088cc,stroke:#005fa3,color:#fff
    style CreateSession fill:#27ae60,stroke:#1e8449,color:#fff
    style DisplayCards fill:#f39c12,stroke:#d68910,color:#fff
    style MemberView fill:#e74c3c,stroke:#c0392b,color:#fff
    style OwnerView fill:#27ae60,stroke:#1e8449,color:#fff
    style CostsTab fill:#3498db,stroke:#2980b9,color:#fff
    style ClickLogout fill:#95a5a6,stroke:#7f8c8d,color:#fff